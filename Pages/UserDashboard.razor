@page "/dashboard"
@using CRUD_Employee_standAlone.Models
@using CRUD_Employee_standAlone.Services
@inject IJSRuntime JSRuntime
@inject AuthService AuthService
@inject CategoryService CategoryService

<PageTitle>Dashboard</PageTitle>

<div class="h-screen flex flex-col">
    <!-- Dashboard Content -->
    <div class="flex-1 relative bg-gray-100">
        
        @if (isLoading)
        {
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium">Loading Dashboard...</p>
                </div>
            </div>
        }
        else if (isAdmin)
        {
            <!-- Admin Dashboard View -->
            <div class="p-6">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard Overview</h1>
                    <p class="text-gray-600 mt-2">System overview and category management</p>
                </div>

                <!-- Admin Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Categories</p>
                                <p class="text-2xl font-bold text-gray-900">@allCategories.Count</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Users</p>
                                <p class="text-2xl font-bold text-gray-900">@totalUsers</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Active Permissions</p>
                                <p class="text-2xl font-bold text-gray-900">@totalPermissions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Preview for Admin -->
                @if (allCategories.Any())
                {
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-semibold text-gray-900">Available Categories</h2>
                            <a href="/manage-categories" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Manage All →
                            </a>
                        </div>
                        
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            @foreach (var category in allCategories.Take(6))
                            {
                                <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
                                    <div class="flex items-start justify-between">
                                        <h3 class="font-medium text-gray-900">@category.Name</h3>
                                        @if (!string.IsNullOrEmpty(category.Link))
                                        {
                                            <a href="@category.Link" target="_blank" 
                                               class="text-blue-500 hover:text-blue-700">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M14 4h6m0 0v6m0-6L10 14"></path>
                                                </svg>
                                            </a>
                                        }
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">@category.Content</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (selectedCategory == null)
        {
            <!-- No Category Selected for Users -->
            <div class="flex items-center justify-center h-full">
                <div class="text-center p-8">
                    <svg class="w-16 h-16 text-blue-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Dashboard Access</h3>
                    <p class="text-gray-600 mb-4">You don't have access to any dashboard categories yet.</p>
                    <p class="text-sm text-gray-500">Contact your administrator to get access to dashboard categories.</p>
                </div>
            </div>
        }
        else
        {
            <!-- User Category Dashboard -->
            <!-- Category Header -->
            @* <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900">@selectedCategory.Name Dashboard</h1>
                        <p class="text-gray-600 mt-1">@selectedCategory.Content</p>
                    </div>
                </div>
            </div> *@

            <!-- Dashboard iframe or No Link Message -->
            <div class="flex-1 relative h-screen">
                @if (!string.IsNullOrEmpty(selectedCategory.Link))
                {
                    <!-- Loading overlay -->
                    <div id="dashboard-loading" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            <p class="text-gray-600 font-medium">Loading @selectedCategory.Name Dashboard...</p>
                            <p class="text-sm text-gray-500 mt-2">This may take a few moments...</p>
                        </div>
                    </div>

                    <!-- Dashboard iframe -->
                    <iframe id="dashboard-frame"
                            title="@selectedCategory.Name Dashboard"
                            class="w-full h-full border-0"
                            src="@selectedCategory.Link"
                            frameborder="0"
                            allowFullScreen="true"
                            onload="hideDashboardLoading()">
                    </iframe>

                    <!-- Error fallback -->
                    <div id="dashboard-error" class="hidden absolute inset-0 bg-gray-50 flex items-center justify-center">
                        <div class="text-center p-8">
                            <svg class="w-16 h-16 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Unable to Load Dashboard</h3>
                            <p class="text-gray-600 mb-4">There was a problem loading the @selectedCategory.Name dashboard.</p>
                            <button @onclick="ReloadDashboard" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200">
                                Try Again
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- No Link Available -->
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center p-8">
                            <svg class="w-16 h-16 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Dashboard Link</h3>
                            <p class="text-gray-600 mb-4">The @selectedCategory.Name category doesn't have a dashboard link configured.</p>
                            <p class="text-sm text-gray-500">Contact your administrator to add a dashboard link for this category.</p>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<script>
    function hideDashboardLoading() {
        const loading = document.getElementById('dashboard-loading');
        if (loading) {
            setTimeout(() => {
                loading.style.display = 'none';
            }, 1000);
        }
    }

    // Show error if iframe fails to load after 30 seconds
    setTimeout(() => {
        const loading = document.getElementById('dashboard-loading');
        const error = document.getElementById('dashboard-error');
        if (loading && loading.style.display !== 'none') {
            loading.style.display = 'none';
            if (error) {
                error.classList.remove('hidden');
            }
        }
    }, 30000);
</script>

@code {
    [CascadingParameter] public Category? selectedCategory { get; set; }

    private bool isLoading = true;
    private bool isAdmin = false;
    private List<Category> allCategories = new();
    private int totalUsers = 0;
    private int totalPermissions = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is admin
            var role = await AuthService.GetRoleAsync();
            isAdmin = role?.ToLower() == "admin";

            if (isAdmin)
            {
                // Load admin dashboard data
                await LoadAdminDashboardData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAdminDashboardData()
    {
        try
        {
            // Load categories for admin view
            allCategories = await CategoryService.GetCategoriesAsync();

            // Load users count
            var users = await AuthService.GetAllUsersAsync();
            totalUsers = users?.Count ?? 0;

            // Load permissions count
            var permissions = await CategoryService.GetAllUserPermissionsAsync();
            totalPermissions = permissions?.Sum(p => p.Permissions.Count) ?? 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading admin data: {ex.Message}");
        }
    }

    private async Task ReloadDashboard()
    {
        await JSRuntime.InvokeVoidAsync("eval", @"
            const frame = document.getElementById('dashboard-frame');
            const error = document.getElementById('dashboard-error');
            const loading = document.getElementById('dashboard-loading');
            if (frame && error && loading) {
                error.classList.add('hidden');
                loading.style.display = 'flex';
                frame.src = frame.src; // Reload iframe
            }
        ");
    }
}